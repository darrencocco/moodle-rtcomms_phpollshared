define("rtcomms_phppollshared/worker",["rtcomms_phppoll/realtime","core/pubsub","local_rtcomms/events","local_webworkers/web_worker"],(function(phpPoll,PubSub,RealTimeEvents,webWorker){return{init:function(){let portMap=new Map,portToChannelMap={},channelToPortMap={},channelBacklog=[],phpPollInitialised=!1;self.addEventListener("connect",(e=>{const port=e.ports[0];let clientId=portNumber.next().value;port.clientId=clientId,portMap.set(clientId,port),portToChannelMap[clientId]=[],port.addEventListener("message",handleClientMessage(port.clientId)),port.start()}));let handleMessage=(clientId,e)=>{let port=getClientPort(clientId);var data,configuration;if(void 0!==port)switch(e.data.type){case"configure":phpPollInitialised||(configuration=e.data.configuration,phpPollInitialised=!0,phpPoll.init(configuration),channelBacklog.length>0&&phpPoll.subscribe());break;case"listen":(function(port,channelName){return portToChannelMap[port.clientId].includes(channelName)})(port,getChannelName(e.data.channel))||function(port,channel){let channelName=getChannelName(channel);portToChannelMap[port.clientId].push(channelName),channelToPortMap.hasOwnProperty(channelName)||(channelToPortMap[channelName]=[],PubSub.subscribe(channelName,serverMessageHandler));channelToPortMap[channelName].push(port.clientId),null===phpPoll?channelBacklog.push(channel):phpPoll.subscribe()}(port,e.data.channel);break;case"close":!function(clientId){delete portMap[clientId],portToChannelMap.clientId.forEach((channel=>{let index=channelToPortMap[channel].indexOf(clientId);channelToPortMap[channel].splice(index,1)})),delete portToChannelMap[clientId]}(port.clientId),delete port.clientId;break;case"ping":port.postMessage({type:"pong"});break;case"send":data=e.data,phpPoll.sendToServer(data.contextId,data.component,data.area,data.itemId,data.payload);break;default:port.postMessage("error")}},handleClientMessage=clientId=>e=>handleMessage(clientId,e),serverMessageHandler=function(message){let channelName=function(message){return getChannelName({context:message.context.id,component:message.component,area:message.area,itemid:message.itemid})}(message);channelToPortMap.hasOwnProperty(channelName)&&channelToPortMap[channelName].forEach((clientId=>{var _getClientPort;null===(_getClientPort=getClientPort(clientId))||void 0===_getClientPort||_getClientPort.postMessage({type:"message",message:message})}))};function getClientPort(clientId){return portMap.get(clientId)}let portNumber=function*(){for(let i=0;i<Infinity;i+=1)yield i}();function getChannelName(channelData){return RealTimeEvents.EVENT+"/"+channelData.context+"/"+channelData.component+"/"+channelData.area+"/"+channelData.itemid}webWorker.workerSetupComplete()}}}));

//# sourceMappingURL=worker.min.js.map